"""
Embedding generator for Medibot.

- Uses sentence-transformers via LangChain HuggingFaceEmbeddings.
- Supports device override via env var: MEDIBOT_EMBED_DEVICE (cpu|mps)
- Provides backward-compatible load_model() used by older code paths.
"""

from __future__ import annotations

import os
from typing import Optional

from langchain_community.embeddings import HuggingFaceEmbeddings

try:
    # Your logger helper (present in your project)
    from src.utils.logger import get_main_logger
except Exception:
    get_main_logger = None


class EmbeddingGenerator:
    def __init__(
        self,
        model_name: str = "sentence-transformers/all-MiniLM-L6-v2",
        device: Optional[str] = None,
    ) -> None:
        self.model_name = model_name

        # ENV override wins (lets us force CPU to avoid native crashes)
        env_device = os.getenv("MEDIBOT_EMBED_DEVICE", "").strip().lower()
        if env_device in {"cpu", "mps"}:
            self.device = env_device
        else:
            # If caller provided device, use it; otherwise default to cpu for stability
            self.device = (device or "cpu").lower()

        self._embeddings: Optional[HuggingFaceEmbeddings] = None

        self.logger = get_main_logger() if get_main_logger else None
        if self.logger:
            self.logger.info("Initializing EmbeddingGenerator")
            self.logger.info(f"Model: {self.model_name}")
            self.logger.info(f"Device: {self.device}")

    def load(self) -> HuggingFaceEmbeddings:
        """Load embeddings (cached)."""
        if self._embeddings is not None:
            return self._embeddings

        # IMPORTANT: if MPS causes native crashes on some ops, forcing cpu avoids it.
        # We still allow mps if explicitly requested.
        requested = self.device

        try:
            self._embeddings = HuggingFaceEmbeddings(
                model_name=self.model_name,
                model_kwargs={"device": requested},
            )
            return self._embeddings
        except Exception as e:
            # Fallback to CPU for python-level errors
            # (Segfaults cannot be caught; hence cpu default)
            if self.logger:
                self.logger.warning(f"Embedding load failed on '{requested}', falling back to cpu. Error: {e}")
            self.device = "cpu"
            self._embeddings = HuggingFaceEmbeddings(
                model_name=self.model_name,
                model_kwargs={"device": "cpu"},
            )
            return self._embeddings

    # âœ… Backward-compatible alias used by older code
    def load_model(self) -> HuggingFaceEmbeddings:
        return self.load()

    @property
    def embeddings(self) -> HuggingFaceEmbeddings:
        return self.load()
